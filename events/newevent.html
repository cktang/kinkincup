<!DOCTYPE html>
<html ng-app='m'>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/css/bootstrap.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.13/angular.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/0.12.1/ui-bootstrap-tpls.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Oswald:400,700,300' rel='stylesheet' type='text/css'>	
	<link href="css/style.css" rel="stylesheet">
	<meta name="apple-mobile-web-app-capable" content="yes">

	<script src="https://cdn.firebase.com/js/client/2.2.2/firebase.js"></script>
	<script src="https://cdn.firebase.com/libs/angularfire/1.0.0/angularfire.min.js"></script>

	<Script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
	<Script src="js/angular-underscore.js"></script>
</head>

<body ontouchstart="" ng-controller="controller">
	<div class="headerplaceholder" ng-include="'header.html'"></div>
	<div class="footerplaceholder" ng-include="'footer.html'"></div>

	<style>
		h4.btn, h6.btn {
			background-color: #eee;
		}

		.dashboard .btn {
			height: 100px;
			font-size: 20px;
			border: 0px solid silver;
			border-radius: 5px;
			background-color: #eee;
			position:relative;
			padding:10px;
			margin:10px;
			margin-bottom: 0px;
		}

		.dashboard .icon {
			position:absolute;
			left: 5px;
			opacity: 0.3;
		}

		.dashboard .col-xs-10 {
			 width:332px
		}

		.dashboard .main {
			line-height:75px;
		}

		.dashboard .badge {
			vertical-align: super;
		}

		.dashboard .sub {
			float:right;
			width:30%;
			font-size: 12px;
		}

		.dashboard .sub .badge {
			font-size: 8px;
			font-weight: normal;
		}

		.dashboard .new {
			border: 5px dotted silver;
		}

		#form2 .field {
			width: 40%;
			margin-right: 10%;
			float:left;
		}

		#form2 .choice {
			border-bottom: 1px solid silver;
			padding: 5px;
		}

		#form3 .field {
			width:80%;
		}
	</style>

	<div class="container">	
      	<h4 class="btn" modal="form1" ng-class="{good:newEvent.name, bad:!newEvent.name}" ng-click="openEvent()"> 
      		{{newEvent.name || 'Event Name ???'}}
			<Br>
			<small>{{newEvent.description || 'Event Description ???'}}</small>
		</h4>

		<div class="row dashboard">
		  <div class="col-xs-10 btn" 
		  	ng-class="{good: newTopics['time'], bad: !newTopics['time']}" 
		  	ng-click="openTopic('time')">
		  	<span class="icon"><img src="img/calendar.png"/></span>
		  	<span class="main">
		  		Time ???
		  	</span>
		  </div>
		  <div class="col-xs-10 btn" 
		  	ng-class="{good: newTopics['venue'], bad: !newTopics['venue']}" 
		  	ng-click="openTopic('venue')">
		  	<span class="icon"><img src="img/location.png"/></span>
		  	<span class="main">
		  		Venue ???
		  	</span>
		  </div>
		  <div class="col-xs-10 btn" 
		  	ng-class="{good: _(users).filter({ selected: true }).length > 0, bad:_(users).filter({ selected: true }).length <= 0}" 
		  	ng-click="openParticipants()">
		  	<span class="icon"><img src="img/running.png"/></span>
		  	<span class="main">
		  		Participants ???
		  	</span>
		  </div>
		  <div class="col-xs-10 btn new" ng-click="openTopic('newTopic')">
		  	<span class="main"> Gift?? Reminder??? Travel Tips?? </span>
		  </div>
		</div>

		<hr>
		<button ng-click="addEvent()" class="btn btn-block btn-warning"> Submit </button>

		<!-- Modal -->
		<div class="modal fade" id="form1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel">New Event</h4>
		      </div>
		      <div class="modal-body">
		      	  <div class="form-group">
				    <label for="name">Name</label>
				    <input type="text" class="form-control" placeholder="Event Name" ng-model="newEvent.name">
				  </div>
				  <div class="form-group">
				    <label for="description">Description</label>
				    <textarea type="description" class="form-control" placeholder="Event Description" ng-model="newEvent.description"></textarea>
				  </div>		      	
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-primary" data-dismiss="modal">Confirm</button>
		      </div>
		    </div>
		  </div>
		</div> 

		<!-- Modal -->
		<div class="modal fade" id="form4" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel">Participants</h4>
		      </div>
		      <div class="modal-body" style="padding-top:0px; padding-bottom:0px">
				  <h5 	ng-repeat="u in users" 
				  		class="full" 
				  		style="border-bottom:1px solid silver" 
				  		ng-click="u.selected = !u.selected" 
				  		ng-class="{'label-success': u.selected}">
				  	<span ng-show="u.selected"><i class="pull-right glyphicon glyphicon-ok"></i></span> 
				  	<span>{{u.name}}</span>
				  </h5>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
		      </div>
		    </div>
		  </div>
		</div>

		<!-- Modal -->
		<div class="modal fade" id="form5" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h4 class="modal-title" id="myModalLabel">Topic</h4>
		      </div>
		      <div class="modal-body">
		      	  <div class="form-group">
				    <label for="name">Name</label>
				    <input type="text" class="form-control" placeholder="Topic Name" ng-model="currentTopic.name">
				  </div>
				  <div class="form-group">
				    <label for="description">Description</label>
				    <textarea type="description" class="form-control" placeholder="Event Description" ng-model="currentTopic.description"></textarea>
				  </div>		      	
				  <div class="form-group">
				    <label for="choices">Choices</label>
				    <input type="text" class="form-control" placeholder="Choice 1" ng-model="currentTopic.choices[0]"/>
				    <input type="text" class="form-control" placeholder="Choice 2" ng-model="currentTopic.choices[1]"/>
				    <input type="text" class="form-control" placeholder="Choice 3" ng-model="currentTopic.choices[2]"/>
				    <input type="text" class="form-control" placeholder="Choice 4" ng-model="currentTopic.choices[3]"/>
				    <input type="text" class="form-control" placeholder="Choice 5" ng-model="currentTopic.choices[4]"/>
				  </div>	
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
		        <button type="button" class="btn btn-primary" ng-click="saveTopic()">Confirm</button>
		      </div>
		    </div>
		  </div>
		</div>

		<div class="bottomplaceholder"></div>
	</div>

	
	<script>
		var app = angular
					.module("m", ["firebase", 'ui.bootstrap', 'angular-underscore'])
					.controller("controller", 
						function($scope, $firebaseArray, $window) {
						    $scope.users = $firebaseArray(new Firebase("https://eventshk.firebaseio.com/user"));
						    $scope.events = $firebaseArray(new Firebase("https://eventshk.firebaseio.com/event"));
						    $scope.topics = $firebaseArray(new Firebase("https://eventshk.firebaseio.com/topic"));

							$scope.times = [];
							$scope.venues = [];

							$scope.newTopics = {};

							var count = 1;

							$scope.addEvent = function() {
								if (!$scope.newEvent || !$scope.newEvent.name || !$scope.newEvent.description) {
									alert('fill in name and description');
									return;
								}

								//add users
								$scope.newEvent.users = $scope._($scope.users).chain().filter({ selected: true }).pluck('$id').value();
								// $scope.newEvent.topics = $scope._($scope.newTopics).chain().filter({ selected: true }).pluck('$id').value();

								$scope.events.$add($scope.newEvent).then(function(ref) {
									$scope.newEvent = $scope.events.$getRecord(ref.key());
									$scope.saveTopics(ref.key());									
								});
							};

							$scope.saveTopics = function(id) {
								console.log('save topics');

								$scope.newTopicIds = [];

								_($scope.newTopics).each(function(topic) {
									topic.event = id;

									$scope.topics.$add(topic).then(function(ref) {
										$scope.newTopicIds.push(ref.key());

										if ($scope.newTopicIds.length == _($scope.newTopics).values().length) {
											$scope.updateEvent();
										}
									});
								});
							};

							$scope.updateEvent = function() {
								console.log('update event');
								$scope.newEvent.topics = $scope.newTopicIds;
								$scope.events.$save($scope.newEvent).then(function() {
									$scope.goto($scope.newEvent.$id);
								});
							}

							$scope.openTopic = function(id) {
								if (id == 'newEvent') {
									id = 'newEvent ' + count++;
								}

								$scope.currentTopic = $scope.newTopics[id];
								$scope.currentTopic = $scope.currentTopic || { name:id, decision:"NOT_DECIDED" };
								$scope.topicId = id;
								$('#form5').modal();
							};

							$scope.saveTopic = function(id) {
								$scope.newTopics[$scope.topicId] = $scope.currentTopic;
								$('#form5').modal('hide');
							};

							$scope.openParticipants = function() {
								$('#form4').modal();
							};

							$scope.openEvent = function() {
								$('#form1').modal();
							};

							$scope.goto = function(id) {
								var url = "eventsummary.html?id=" + id;
								try {
		  							linkEvent(url);
								} catch (e) {
		  							$window.location.href = url;
	  							}
	  						};
						}
					);
	</script>
</body>
</html>
