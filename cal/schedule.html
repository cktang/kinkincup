<!DOCTYPE html>
<html ng-app="app">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.13/angular.js"></script>	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.13/angular-route.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular-animate.js"></script>

	<script src="https://cdn.firebase.com/js/client/2.2.2/firebase.js"></script>
	<script src="https://cdn.firebase.com/libs/angularfire/1.0.0/angularfire.min.js"></script>

    <Script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
	<Script src="js/angular-underscore.js"></script>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
	<meta name="viewport" content="width=device-width" /> 

    <script src="js/semantic/semantic.js"></script>	
	<link href="js/semantic/semantic.css" rel="stylesheet">
	
    <script src="js/semantic/components/modal.js"></script>	
	<link href="js/semantic/components/modal.css" rel="stylesheet">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-moment/0.10.1/angular-moment.js"></script>

	<meta name="apple-mobile-web-app-capable" content="yes"/>
</head>

<body ontouchstart="" ng-controller="Controller">	
	<style>
		.column.today {
			background: pink !important;
			color: brown !important;	
		}
				
		.ui.column {			
			background-color: white;
		}
		
		.column.weekend, .column.header {
			background-color: lightblue;
			color: navy;
		}
		
		.ui.duty1 {
			background-color: #fee;
		}
		.ui.duty2 {
			background-color: #fdd;
		}
		.ui.duty3 {
			background-color: #fcc;
		}
		.ui.dutyO {
			background-color: lightyellow;
		}
		.ui.dutyL {
			background-color: #cfc;
		}
				
		.ui.manual.duty1 {
			background-color: #999;
			color: white;
		}
		.ui.manual.duty2 {
			background-color: #777;
			color: white;
		}
		.ui.manual.duty3 {
			background-color: #555;
			color: white;
		}
		.ui.manual.dutyO {
			background-color: black;
			color: white;
		}
		.ui.manual.dutyL {
			background-color: #333;
			color: white;
		}
		
		#dates {
			margin-top: 100px;
		} 
		
		.ui.column.grid {
			margin-left: 10px;
		}
		
		.ui.column.grid .column {
			width: 2.6% !important;
			text-align: center;
			padding: 0.3em !important;
		}

		.link, .button { transition: all .1s; }
		.link:active, .button:active { 
			-webkit-transform-style: preserve-3d;
		    -webkit-transform: scale3d(0.9, 0.9, 0.9);
		   	opacity:0.7; 
		}
		
		.subtotal {
			opacity: 0.3;
		}
		
		.subtotal .negative {
			color: red;
			font-weight: bold;
		}
		.subtotal .positive {
			color: green;
			font-weight: bold;
		}
	</style>
	
	<div class="ui fixed menu" id="menu">
		<div class="ui item"> 
			<h4>Month</h4>
			<h1> {{ d | amDateFormat: 'MMMM YYYY' }} </h1> 
		</div>
		
		<div class="ui item">
			<h4>Preference</h4>
			<div class="ui buttons">
			  	<div ng-repeat="d in duty" 
			      class="ui button duty{{d}}" 
				  ng-class="{big: choice==d}" 
				  ng-click="setChoice(d)" 
				  ng-bind="d">
				</div> 
			  	<div class="ui button" ng-class="{big: choice==null}" ng-click="setChoice(null)" > Clear </div>
			</div>
		</div>
		
		<div class="ui item">
			<h4>Lock</h4>
			<div class="ui buttons">
			  	<div class="ui button" ng-class="{big: choice==null}" ng-click="setLock(null)" > Current </div>
			  	<div ng-repeat="d in duty" 
			      class="ui button duty{{d}}" 
				  ng-class="{big: lock==d}" 
				  ng-click="setLock(d)" 
				  ng-bind="d">
				</div>
			  	<div class="ui button" ng-class="{big: choice==null}" ng-click="setLock(null)" > Clear </div>
			</div>
		</div>
		
		<div class="ui item">
			<h4>Action</h4>
			<span class="ui negative button" ng-click="clearBoard()">Clear Board</span>
			<br></br>
			<span class="ui negative button" ng-click="clearLock()">Clear Lock</span>
			<br></br>
			<span class="ui positive button" ng-click="findSolution()">Auto Assign</span>
		</div>
		
		<div class="ui item">
			<h4>Memory</h4>
			<span class="ui negative button" ng-click="save()">Save</span>
			<br></br>
			<span class="ui positive button" ng-click="load()">Load</span>
		</div>
				
		<span class="ui floated right item">
			<h1>
				<i class="ui angle left icon link" ng-click="lastMonth()"></i>
				<i class="ui angle right icon link" ng-click="nextMonth()"></i>
			</h1>
		</span>
	</div>
	
	<div id="dates" class="ui column grid">	
		<div class="column"> &nbsp;</div>		
		<div 
			class="column link header"
			ng-class="{selected: events.items[date].d, 'today':date==today}"
			ng-repeat="date in dd.dates">
			<div class="ui dText">{{ date | amDateFormat: 'ddd' }}</div>
			<div class="ui dText">{{ date | amDateFormat: 'D' }}</div>
		</div>
		<div class="ui column duty{{d}}" ng-repeat='d in duty'>
			<div class="ui dText" ng-bind="d"></div>
			<div class="ui dText">&nbsp;</div>
		</div>
	</div>
	
	<div ng-repeat="p in person" class="ui column grid">
		<div class="column header" ng-bind="p.name"></div>		
		<div 
			class="ui column link {{ 'duty' + date.duty }}"
			ng-class="{manual: date.method=='manual'}"
			ng-click="date.duty = choice; date.method = 'manual'"
			ng-repeat="date in p.dates">
			<span class="ui dText"> {{ date.duty || "/" }} </span>
		</div>
		<div class="ui column duty{{d}} subtotal" ng-repeat="d in duty" ng-bind="_(p.dates).where({ duty: d }).length"></div>		
	</div>
	 	
	<div class="ui column grid subtotal" ng-repeat="d in duty">
		<div class="ui column duty{{d}}" ng-bind="d"></div>		
		<div 
			class="ui column link duty{{d}}"
			ng-class="{negative: getColumnCount($index, d) != 2, positive: getColumnCount($index, d) == 2}"
			ng-repeat="date in dd.dates">
			<div class="ui" ng-bind="getColumnCount($index, d) || 0"></div>
		</div>	
	</div>

	<div class="ui message">
		<div> Rules </div>
		
		<div>1. Each day min 2, max 4 ppl for duty 1,2,3</div>
		<div>2. Each ppl can have exactly 8 days of O</div>
		<div>3. Each ppl cannot work consecutively more than 6 days</div>
		<div>4. After duty 2, cannot be duty 1</div>
		<div>5. After duty 3, cannot be duty 1 or 2</div>
		<div>6. Ppl want to have preference like duty 1 or O</div>
	<script>
		var app = angular
					.module('app', ['angularMoment', "ngRoute", "firebase", 'angular-underscore'])
		  			.controller("Controller", 
						function($scope, $firebaseObject, $firebaseArray, $window, $routeParams, $timeout) {
							$scope.duty = ['1', '2', '3', 'O', 'L'];
							$scope.choice = "1";

							$scope.personRules = [
								// O >= 8
								function(person) {
//									console.log('person cond 1');
									return _(person.dates).countBy('duty')['O'] >= 8;
								}
							];

							$scope.dayRules = [								
								// everyday has at least 2 1s, 2 2s, and 2 3s
								function(list) {
									var condition = true;
									var group = _(list).chain().map(function(person) { return _(person.dates).pluck('duty'); }).unzip().value();
									_(group).each(function(day) {
										if (!condition) return;
										var countBy = _(day).countBy();
										condition =
											countBy['1'] >= 1 && 
											countBy['2'] >= 1 &&
											countBy['3'] >= 1;
									});
									return condition;
								}
							];
							
							$scope.person = [
								{ name: 'LAW' }, 	{ name: 'LEE' }, 
								{ name: 'HO' }, 	{ name: 'KUEN' }, 
								{ name: 'YIP' }, 	{ name: 'POON' }, 
								{ name: 'WONG' }, 	{ name: 'KIT' },
								{ name: 'CHEUNG' },		{ name: 'LAU' },
								{ name: 'YEUNG' },	{ name: 'LIZ' },
							];

							$scope.d = moment();
							$scope.today = $scope.d.format('YYYY-MM-DD');
							$scope.tries = 0;
							$scope.solutionFound = false;
								
							$scope.nextMonth = function() { 
								$scope.d = $scope.d.add(1, 'M'); 
								$scope.defineCal(); 								
							};
							
							$scope.lastMonth = function() { 
								$scope.d = $scope.d.add(-1, 'M'); 						
								$scope.defineCal(); 
							};
							
							$scope.isValid = function(rules, list) {
								var condition = true;
								_(rules).each(function(rule) {
									condition = condition && rule(list);
								});					
									
								return condition;
							};
							
							$scope.findSolution = function() {
								if ($scope.solutionFound) return;
					        	$scope.tries++;

								_($scope.person).each(function(p) {
									_(p.dates).each(function(d) { 
										if (d.method == 'manual') return;	
										d.duty = null; 
									});
									while(!$scope.isValid($scope.personRules, p)) {
										_(p.dates).each(function(d) {		
											if (d.method == 'manual') return;	
											d.duty = _($scope.duty).shuffle()[0];
										})
									}
								});
									
								if ($scope.isValid($scope.dayRules, $scope.person)) {
									console.log('solution!');
									$scope.solutionFound = true;
									$scope.solution = $scope.person;
									console.log($scope.solution);
								} else {
//									$timeout.cancel();
//									$timeout($scope.findSolution, 0);
								} 
							}
							
							$scope.defineCal = function() {
								var d = new moment($scope.d.toDate()).startOf('month');
								$scope.dd = $scope.dd || {};
	
								_($scope.person).each(function(p) {	p.dates = []; });
								$scope.dd.dates = [];
									
								while(true) {
									$scope.dd.dates.push(d.format('YYYY-MM-DD'));
									_($scope.person).each(function(p, i) {
										p.dates.push({ date: d.format('YYYY-MM-DD') });
									});
									d.add(1, 'd');
									if (d.format('DD') == 1) break;
								}				
								
								$timeout.cancel();
								$timeout($scope.findSolution, 0);								
							};
							$scope.defineCal();
							
							$scope.setChoice = function(d) {
								$scope.choice = d;
							};
							
							$scope.getColumnCount = function(column, duty) {
								return _($scope.person).chain()
											.map(function(p) { return p.dates[column].duty; })
											.countBy()
											.value()[duty];	
							};
							
							$scope.clearBoard = function() {
								_($scope.person).each(function(p) {
									_(p.dates).each(function(d) {																		
										if (d.method=='manual') return;
										d.duty = null;
									});
								});
							};

							$scope.clearLock = function() {
								_($scope.person).each(function(p) {
									_(p.dates).each(function(d) {																		
										d.method = null;
									});
								});
							}
						});
	</script>
</body>
</html>